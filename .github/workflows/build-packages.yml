name: Build APT Packages

on:
  push:
    branches: [ main, 002-production-ci-cd ]  # Added for testing
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      architecture:
        description: 'Target architecture'
        required: false
        default: 'all'
        type: choice
        options: ['amd64', 'arm64', 'all']
      force_rebuild:
        description: 'Force rebuild even if no changes detected'
        type: boolean
        required: false
        default: false

env:
  DEBIAN_FRONTEND: noninteractive
  PACKAGE_NAME: local-rag
  
jobs:
  build:
    name: Build Package (${{ matrix.arch }})
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
        include:
          - arch: amd64
            cross_compile: false
            platform: linux/amd64
          - arch: arm64
            cross_compile: true  
            platform: linux/arm64
            
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version detection
          
      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            debhelper \
            dh-python \
            python3-all \
            python3-setuptools \
            python3-pip \
            python3-dev \
            lintian \
            devscripts \
            dpkg-dev \
            fakeroot
            
      - name: Set up QEMU for cross-compilation
        if: matrix.cross_compile
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.platform }}
          
      - name: Configure cross-compilation environment
        if: matrix.cross_compile  
        run: |
          sudo apt-get install -y \
            qemu-user-static \
            binfmt-support \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu
          
          # Configure dpkg for cross-compilation
          sudo dpkg --add-architecture arm64
          sudo apt-get update
          
      - name: Set up Python environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Extract version information
        id: version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="0.1.0+git.$(git rev-parse --short HEAD)"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "BUILD_VERSION=${VERSION}" >> $GITHUB_ENV
          
      - name: Prepare build directory
        run: |
          # Copy packaging files to root for dpkg-buildpackage
          cp -r packaging/debian .
          
          # Update version in debian files
          sed -i "s/0\.1\.0/${{ steps.version.outputs.version }}/g" debian/control || true
          
      - name: Install build dependencies
        run: |
          # Install Python dependencies needed for building
          python3 -m pip install --upgrade pip setuptools wheel
          python3 -m pip install build
          
          # Install test dependencies for coverage validation
          python3 -m pip install pytest pytest-cov
          
      - name: Build source package
        run: |
          # Generate source package for dpkg-buildpackage
          dpkg-source --build .
          
      - name: Run test coverage validation  
        run: |
          # Install package dependencies for testing
          python3 -m pip install -e ".[dev]"
          
          # Run tests with coverage
          python3 -m pytest --cov=src --cov-report=term --cov-report=xml --cov-fail-under=85
          
          # Upload coverage to artifacts
          mkdir -p coverage-reports
          cp coverage.xml coverage-reports/ 2>/dev/null || true
          
          echo "âœ… Test coverage validation passed (â‰¥85% required)"
          
      - name: Security dependency scanning
        run: |
          # Install security scanning tools
          python3 -m pip install safety bandit
          
          # Create security reports directory
          mkdir -p security-reports
          
          # Run safety check for known vulnerabilities
          echo "ðŸ” Scanning Python dependencies for vulnerabilities..."
          python3 -m safety check --json --output security-reports/safety-report.json || true
          python3 -m safety check --short-report
          
          # Run bandit security linter
          echo "ðŸ” Running Bandit security analysis..."
          python3 -m bandit -r src/ -f json -o security-reports/bandit-report.json || true
          python3 -m bandit -r src/ -ll  # Low confidence, only show issues
          
          # Check for critical vulnerabilities and fail if found
          if python3 -m safety check --short-report | grep -i "CRITICAL\|HIGH"; then
            echo "âŒ Critical or High severity vulnerabilities found!"
            echo "Build will continue but security review is required."
            # For Phase 1, we'll warn but not fail the build
            # In production, uncomment the next line to fail:
            # exit 1
          else
            echo "âœ… No critical vulnerabilities detected in dependencies"
          fi
          
      - name: Build binary package
        run: |
          if [[ "${{ matrix.arch }}" == "arm64" ]]; then
            # Cross-compilation for ARM64
            dpkg-buildpackage \
              -us -uc \
              -a arm64 \
              --host-arch arm64 \
              -j$(nproc)
          else
            # Native compilation for AMD64
            dpkg-buildpackage \
              -us -uc \
              -a amd64 \
              -j$(nproc)
          fi
          
      - name: Basic package validation
        run: |
          # Find the generated package
          PACKAGE_FILE=$(find .. -name "*.deb" -type f | head -1)
          
          if [[ -z "$PACKAGE_FILE" ]]; then
            echo "ERROR: No .deb package found"
            exit 1
          fi
          
          echo "Found package: $PACKAGE_FILE"
          echo "PACKAGE_FILE=$PACKAGE_FILE" >> $GITHUB_ENV
          
          # Basic file validation
          file "$PACKAGE_FILE"
          dpkg --info "$PACKAGE_FILE"
          dpkg --contents "$PACKAGE_FILE"
          
          # Run lintian validation
          echo "Running lintian validation..."
          lintian "$PACKAGE_FILE" || true  # Don't fail build on lintian warnings initially
          
      - name: Test package installation (AMD64 only)
        if: matrix.arch == 'amd64'
        run: |
          # Test installation in Docker container
          docker run --rm -v "$(pwd)/../:/packages" ubuntu:22.04 bash -c "
            apt-get update && 
            apt-get install -y python3 python3-pip systemd &&
            dpkg -i /packages/*.deb || apt-get install -f -y &&
            echo 'Package installation test completed'
          "
          
      - name: Generate build artifacts
        run: |
          # Create artifacts directory
          mkdir -p artifacts
          
          # Copy package files
          cp ../*.deb artifacts/ 2>/dev/null || true
          cp ../*.buildinfo artifacts/ 2>/dev/null || true
          cp ../*.changes artifacts/ 2>/dev/null || true
          
          # Copy coverage reports
          cp coverage-reports/* artifacts/ 2>/dev/null || true
          
          # Copy security reports  
          cp security-reports/* artifacts/ 2>/dev/null || true
          
          # Generate checksums
          cd artifacts
          for file in *.deb; do
            if [[ -f "$file" ]]; then
              sha256sum "$file" >> checksums.txt
            fi
          done
          
          # List artifacts
          ls -la
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.arch }}
          path: artifacts/
          retention-days: 90
          compression-level: 6
          
      - name: Build summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Architecture**: ${{ matrix.arch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Cross-compilation**: ${{ matrix.cross_compile }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: ${{ matrix.platform }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ -f "artifacts/checksums.txt" ]]; then
            echo "### Package Checksums" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat artifacts/checksums.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: build
    if: always()
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts
          
      - name: Generate build report
        run: |
          echo "# Package Build Report" > build-report.md
          echo "" >> build-report.md
          echo "**Build Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> build-report.md
          echo "**Commit**: ${{ github.sha }}" >> build-report.md
          echo "**Branch**: ${{ github.ref_name }}" >> build-report.md
          echo "" >> build-report.md
          
          echo "## Built Packages" >> build-report.md
          echo "" >> build-report.md
          
          for arch_dir in all-artifacts/packages-*; do
            if [[ -d "$arch_dir" ]]; then
              arch=$(basename "$arch_dir" | sed 's/packages-//')
              echo "### $arch Architecture" >> build-report.md
              echo "" >> build-report.md
              
              if [[ -f "$arch_dir/checksums.txt" ]]; then
                echo '```' >> build-report.md
                cat "$arch_dir/checksums.txt" >> build-report.md
                echo '```' >> build-report.md
              fi
              echo "" >> build-report.md
            fi
          done
          
      - name: Upload build report
        uses: actions/upload-artifact@v4
        with:
          name: build-report
          path: build-report.md
          retention-days: 90