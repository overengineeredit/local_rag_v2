name: PR Validation

on:
  pull_request:
    branches: [main]
    paths-ignore: 
      - 'docs/**'
      - '*.md'
      - 'specs/**'

env:
  PYTHON_VERSION: '3.11'

jobs:
  code-quality:
    name: Code Quality & Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install development dependencies
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run linting checks
        run: |
          ruff check .

      - name: Check code formatting
        run: |
          ruff format --check .

      - name: Run type checking
        run: |
          mypy src/ --ignore-missing-imports || echo "‚ö†Ô∏è Type checking issues found - review recommended but not blocking PR"

      - name: Run security scanning
        run: |
          echo "üîç Checking for security vulnerabilities..."
          
          # Verify pip-audit is installed and working
          echo "Verifying pip-audit installation..."
          python3 -m pip_audit --version || {
            echo "‚ùå pip-audit not found or not working"
            exit 1
          }
          
          # Run pip-audit with proper error handling for editable packages
          echo "Running pip-audit with --skip-editable flag..."
          AUDIT_EXIT_CODE=0
          python3 -m pip_audit --skip-editable --format=json --output=pip-audit-report.json 2>&1 || AUDIT_EXIT_CODE=$?
          
          # pip-audit exit codes: 0 = no vulnerabilities, 1 = vulnerabilities found
          # We handle both cases and focus on critical vulnerabilities only
          if [ $AUDIT_EXIT_CODE -eq 0 ]; then
            echo "‚úÖ No vulnerabilities detected by pip-audit"
          else
            echo "‚ö†Ô∏è pip-audit found issues or completed with warnings (exit code: $AUDIT_EXIT_CODE)"
            echo "Analyzing findings for critical vulnerabilities..."
            
            # Generate human-readable report for analysis
            python3 -m pip_audit --skip-editable --desc > /tmp/audit_output.txt 2>&1 || echo "pip-audit human-readable report generated"
            
            # Check for critical vulnerabilities that would block deployment
            CRITICAL_VULNS=$(grep -E "(code.execution|remote.code|privilege.escalation|sql.injection)" /tmp/audit_output.txt -i || echo "")
            
            if [ -n "$CRITICAL_VULNS" ]; then
              echo "‚ùå Critical security vulnerabilities found that could enable code execution!"
              echo "Critical findings:"
              echo "$CRITICAL_VULNS"
              exit 1
            else
              echo "‚úÖ No critical code execution vulnerabilities detected"
              echo "üìã Non-critical findings logged for review but not blocking PR"
            fi
          fi

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            pip-audit-report.json
          retention-days: 30

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run unit tests
        run: |
          pytest tests/ -v --cov=src --cov-report=term-missing --cov-report=xml

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        if: always()
        with:
          file: ./coverage.xml
          name: codecov-unit-tests

  status-check:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests]
    if: always()
    
    steps:
      - name: Check all jobs status
        run: |
          if [ "${{ needs.code-quality.result }}" != "success" ] || \
             [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo "‚ùå One or more checks failed"
            exit 1
          fi
          echo "‚úÖ All validation checks passed"
